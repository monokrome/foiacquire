#!/bin/bash
# Stealth browser management for foiacquire
# Uses a Docker container with Chromium for anti-bot bypass

set -e

CONTAINER_NAME="foiacquire-chromium"
IMAGE_NAME="foiacquire-chromium:latest"
PORT="${STEALTH_PORT:-9222}"
VNC_PORT="${STEALTH_VNC_PORT:-5900}"

# Find project root (where Dockerfile.chromium lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

usage() {
    echo "Usage: stealth <command>"
    echo ""
    echo "Commands:"
    echo "  build    Build the stealth browser Docker image"
    echo "  start    Start the stealth browser container"
    echo "  stop     Stop the stealth browser container"
    echo "  restart  Restart the stealth browser container"
    echo "  status   Show container status"
    echo "  logs     Show container logs"
    echo ""
    echo "Environment:"
    echo "  STEALTH_PORT      CDP port to expose (default: 9222)"
    echo "  STEALTH_VNC_PORT  VNC port to expose (default: 5900)"
    echo "  VNC_PASSWORD      Enable VNC with this password"
    echo "  VNC_VIEWONLY      Set to 'true' for read-only VNC"
}

cmd_build() {
    echo "Building stealth browser image..."
    docker build -t "$IMAGE_NAME" --build-arg STEALTH=true -f "$PROJECT_DIR/Dockerfile.chromium" "$PROJECT_DIR"
    echo "Done."
}

cmd_start() {
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo "Stealth browser already running on port $PORT"
        return 0
    fi

    # Remove stopped container if exists
    docker rm "$CONTAINER_NAME" 2>/dev/null || true

    echo "Starting stealth browser on port $PORT..."

    # Build environment variable arguments
    ENV_ARGS=()
    [ -n "$VNC_PASSWORD" ] && ENV_ARGS+=(-e "VNC_PASSWORD=$VNC_PASSWORD")
    [ "$VNC_VIEWONLY" = "true" ] && ENV_ARGS+=(-e "VNC_VIEWONLY=true")

    docker run -d --rm \
        --name "$CONTAINER_NAME" \
        --shm-size=2g \
        --network host \
        "${ENV_ARGS[@]}" \
        "$IMAGE_NAME"

    if [ -n "$VNC_PASSWORD" ]; then
        echo "Stealth browser running."
        echo "  CDP: ws://localhost:$PORT"
        echo "  VNC: localhost:$VNC_PORT"
    else
        echo "Stealth browser running. Connect with: ws://localhost:$PORT"
    fi
}

cmd_stop() {
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo "Stopping stealth browser..."
        docker stop "$CONTAINER_NAME"
        echo "Stopped."
    else
        echo "Stealth browser not running."
    fi
}

cmd_restart() {
    cmd_stop && sleep 2
    cmd_start
}

cmd_status() {
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo "Stealth browser: running"
        echo "  CDP: ws://localhost:$PORT"
        # Check if VNC is enabled by inspecting container env
        if docker inspect "$CONTAINER_NAME" --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -q "^VNC_PASSWORD="; then
            echo "  VNC: localhost:$VNC_PORT"
        fi
        docker ps --filter "name=$CONTAINER_NAME" --format "  Container: {{.ID}}\n  Image: {{.Image}}\n  Status: {{.Status}}"
    else
        echo "Stealth browser: stopped"
    fi
}

cmd_logs() {
    docker logs "$CONTAINER_NAME" "$@"
}

case "${1:-}" in
    build)
        cmd_build
        ;;
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        exit 1
        ;;
esac
