name: Docker

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
    paths:
      - 'Dockerfile*'
      - 'bin/*entrypoint*.sh'
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/docker.yml'
  workflow_dispatch:

env:
  REGISTRY: docker.io

jobs:
  lint:
    name: Format, Check & Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --check

      - name: Run cargo check (no default features)
        run: cargo check --release --no-default-features

      - name: Run cargo check (safe features)
        run: cargo check --release --features browser,postgres,redis-backend,amqp-broker,ocr-ocrs,ocr-paddle

      - name: Run clippy
        run: cargo clippy --features browser,postgres,redis-backend,amqp-broker,ocr-ocrs,ocr-paddle -- -D warnings

      - name: Check CI references correct binary name
        run: ./scripts/check-binary-name.sh

  browser-compat-test:
    name: Browser Compatibility Test
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build chromium container (stealth mode)
        run: docker build -f Dockerfile.chromium --build-arg STEALTH=true -t chromium-stealth:test .

      - name: Start chromium container
        run: |
          docker run -d --name chromium-test -p 9222:9222 chromium-stealth:test
          echo "Waiting for chromium to start..."
          for i in $(seq 1 30); do
            if curl -s http://localhost:9222/json/version > /dev/null 2>&1; then
              echo "Chromium is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done

      - name: Verify CDP endpoint
        run: |
          echo "=== Chromium Version Info ==="
          curl -s http://localhost:9222/json/version | head -20
          echo ""
          echo "=== Available Targets ==="
          curl -s http://localhost:9222/json/list | head -20

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: browser-compat-test

      - name: Build with browser feature
        run: cargo build --features browser

      - name: Run browser connectivity test
        env:
          BROWSER_URL: ws://localhost:9222
          RUST_LOG: debug
        run: |
          # Run the ignored browser_connection test which requires a running browser
          cargo test --features browser browser_connection -- --ignored --nocapture

      - name: Cleanup
        if: always()
        run: |
          docker logs chromium-test 2>&1 | tail -50 || true
          docker stop chromium-test || true
          docker rm chromium-test || true

  chromium:
    name: Build Chromium Image
    needs: lint
    runs-on: ubuntu-latest
    environment: release
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: monokrome
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: monokrome/chromium
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.chromium
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  chromium-stealth:
    name: Build Chromium Stealth Image
    needs: lint
    runs-on: ubuntu-latest
    environment: release
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: monokrome
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: monokrome/chromium
          tags: |
            type=raw,value=stealth,enable={{is_default_branch}}
            type=raw,value=stealth-{{tag}},enable=${{ startsWith(github.ref, 'refs/tags/') }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.chromium
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          build-args: STEALTH=true
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build binary
  build-binary:
    name: Build Binary
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: standard
            features: "browser,postgres,redis-backend"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build binary
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.builder
          push: false
          load: true
          tags: foiacquire-builder:${{ matrix.name }}
          platforms: linux/amd64
          build-args: |
            FEATURES=${{ matrix.features }}
          cache-from: type=gha,scope=builder-${{ matrix.name }}
          cache-to: type=gha,scope=builder-${{ matrix.name }},mode=max

      - name: Extract binary
        run: |
          docker create --name extract foiacquire-builder:${{ matrix.name }}
          docker cp extract:/build/target/release/foia ./foia-${{ matrix.name }}
          docker rm extract

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.name }}
          path: ./foia-${{ matrix.name }}
          retention-days: 1

  foiacquire:
    name: Build FOIAcquire Image (${{ matrix.tag }})
    needs: build-binary
    runs-on: ubuntu-latest
    environment: release
    strategy:
      matrix:
        include:
          # Tor-enabled variants (default)
          - tag: latest
            binary: standard
            tesseract: "false"
            tor: "true"
          - tag: tesseract
            binary: standard
            tesseract: "true"
            tor: "true"
          # Clearnet variants (no Tor)
          - tag: clearnet
            binary: standard
            tesseract: "false"
            tor: "false"
          - tag: tesseract-clearnet
            binary: standard
            tesseract: "true"
            tor: "false"
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.binary }}

      - name: Prepare binary
        run: mv foia-${{ matrix.binary }} foia

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: monokrome
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: monokrome/foiacquire
          tags: |
            type=raw,value=${{ matrix.tag }},enable={{is_default_branch}}
            type=raw,value=${{ matrix.tag }}-{{tag}},enable=${{ startsWith(github.ref, 'refs/tags/') }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.runtime
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          build-args: |
            WITH_TESSERACT=${{ matrix.tesseract }}
            WITH_TOR=${{ matrix.tor }}
          cache-from: type=gha,scope=runtime-${{ matrix.tag }}
          cache-to: type=gha,scope=runtime-${{ matrix.tag }},mode=max
