name: Docker

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
    paths:
      - 'Dockerfile*'
      - 'bin/entrypoint*.sh'
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/docker.yml'
  workflow_dispatch:

env:
  REGISTRY: docker.io

jobs:
  lint:
    name: Format & Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy --all-features -- -D warnings

  browser-compat-test:
    name: Browser Compatibility Test
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build chromium container (stealth mode)
        run: docker build -f Dockerfile.chromium --build-arg STEALTH=true -t chromium-stealth:test .

      - name: Start chromium container
        run: |
          docker run -d --name chromium-test -p 9222:9222 chromium-stealth:test
          echo "Waiting for chromium to start..."
          for i in $(seq 1 30); do
            if curl -s http://localhost:9222/json/version > /dev/null 2>&1; then
              echo "Chromium is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done

      - name: Verify CDP endpoint
        run: |
          echo "=== Chromium Version Info ==="
          curl -s http://localhost:9222/json/version | head -20
          echo ""
          echo "=== Available Targets ==="
          curl -s http://localhost:9222/json/list | head -20

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: browser-compat-test

      - name: Build with browser feature
        run: cargo build --features browser

      - name: Run browser connectivity test
        env:
          BROWSER_URL: ws://localhost:9222
          RUST_LOG: debug
        run: |
          # Run the ignored browser_connection test which requires a running browser
          cargo test --features browser browser_connection -- --ignored --nocapture

      - name: Cleanup
        if: always()
        run: |
          docker logs chromium-test 2>&1 | tail -50 || true
          docker stop chromium-test || true
          docker rm chromium-test || true

  build-amd64:
    name: Build amd64 Binaries
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - features: browser,postgres
            artifact: foiacquire-browser-amd64
          - features: browser,postgres,redis-backend
            artifact: foiacquire-redis-amd64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y musl-tools cmake perl

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.artifact }}

      - name: Build
        run: cargo build --release --features "${{ matrix.features }}" --target x86_64-unknown-linux-musl

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: target/x86_64-unknown-linux-musl/release/foiacquire

  build-arm64:
    name: Build arm64 Binaries
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - features: browser,postgres
            artifact: foiacquire-browser-arm64
          - features: browser,postgres,redis-backend
            artifact: foiacquire-redis-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.artifact }}

      - name: Build
        run: |
          cross build --release --features "${{ matrix.features }}" --target aarch64-unknown-linux-musl

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: target/aarch64-unknown-linux-musl/release/foiacquire

  chromium:
    name: Build Chromium Image
    needs: lint
    runs-on: ubuntu-latest
    environment: release
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: monokrome
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: monokrome/chromium
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.chromium
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  chromium-stealth:
    name: Build Chromium Stealth Image
    needs: lint
    runs-on: ubuntu-latest
    environment: release
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: monokrome
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: monokrome/chromium
          tags: |
            type=raw,value=stealth,enable={{is_default_branch}}
            type=raw,value=stealth-{{tag}},enable=${{ startsWith(github.ref, 'refs/tags/') }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.chromium
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          build-args: STEALTH=true
          cache-from: type=gha
          cache-to: type=gha,mode=max

  foiacquire:
    name: Build FOIAcquire Image
    needs: [build-amd64, build-arm64]
    runs-on: ubuntu-latest
    environment: release
    strategy:
      matrix:
        include:
          - tag: latest
            artifact: foiacquire-browser
            tesseract: "false"
          - tag: tesseract
            artifact: foiacquire-browser
            tesseract: "true"
          - tag: redis
            artifact: foiacquire-redis
            tesseract: "false"
    steps:
      - uses: actions/checkout@v4

      - name: Download amd64 binary
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}-amd64
          path: dist/amd64/

      - name: Download arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}-arm64
          path: dist/arm64/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: monokrome
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: monokrome/foiacquire
          tags: |
            type=raw,value=${{ matrix.tag }},enable={{is_default_branch}}
            type=raw,value=${{ matrix.tag }}-{{tag}},enable=${{ startsWith(github.ref, 'refs/tags/') }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          build-args: |
            WITH_TESSERACT=${{ matrix.tesseract }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
