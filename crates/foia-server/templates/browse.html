{% extends "base.html" %}

{% block content %}
<div class="browse-filters">
    <div class="filter-row">
        <div class="filter-section source-filter">
            <span class="filter-label">Source:</span>
            <select id="source-select">
                <option value="">All Sources</option>
                {% for s in sources %}
                <option value="{{ s.id }}"{% if s.selected %} selected{% endif %}>{{ s.name }}  ({{ s.count }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-section tag-filter">
            <span class="filter-label">Tags:</span>
            <div class="tag-input-wrapper">
                <input type="text" id="tag-search" list="tag-list" placeholder="Add tag..." autocomplete="off">
                <datalist id="tag-list">
                    {% for tag in all_tags %}
                    <option value="{{ tag.name }}" data-count="{{ tag.count }}">
                    {% endfor %}
                </datalist>
                <div class="active-tags">
                    {% for tag in active_tags_display %}
                    <span class="active-tag">{{ tag.name }} <button type="button" class="clear-tag" onclick="removeTag({{ tag.index }})">x</button></span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="filter-row type-row">
        <div class="filter-section type-filters">
            <span class="filter-label">Types:</span>
            <div class="type-toggles">
                {% for cat in categories %}
                <label class="type-toggle">
                    <input type="checkbox" name="type" value="{{ cat.id }}" {% if cat.checked %}checked{% endif %} data-count="{{ cat.count }}">
                    <span class="toggle-label">{{ cat.name }}</span>
                    <span class="toggle-count">{{ cat.count }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<div class="result-info">
    <span class="result-count">{{ total_count }} documents</span>
</div>
{% if has_pagination %}
<div class="pagination">
    {% if has_prev_cursor %}
    <a href="javascript:void(0)" onclick="goToPage('{{ prev_cursor_val }}')" class="page-link">&laquo; Previous</a>
    {% endif %}
    {% if start_position > 0 %}
    <span class="page-position">{{ start_position }}-{{ end_position }} of {{ total_count }}</span>
    {% endif %}
    {% if has_next_cursor %}
    <a href="javascript:void(0)" onclick="goToPage('{{ next_cursor_val }}')" class="page-link">Next &raquo;</a>
    {% endif %}
</div>
{% endif %}
<table class="file-listing" id="document-table">
    <thead>
        <tr>
            <th>Document</th>
            <th>Source</th>
            <th>Type</th>
            <th>Size</th>
            <th>Acquired</th>
        </tr>
    </thead>
    <tbody>
        {% for doc in documents %}
        <tr data-date="{{ doc.timestamp }}">
            <td>
                <a href="/documents/{{ doc.id }}{{ nav_query_string }}">{{ doc.icon }} {{ doc.title }}</a>
                {% if doc.has_synopsis %}
                <div class="synopsis">{{ doc.synopsis_preview }}</div>
                {% endif %}
                <div class="doc-tags">
                    {% for t in doc.tags %}
                    <a href="/browse?tag={{ t.encoded }}" class="tag-small">{{ t.name }}</a>
                    {% endfor %}
                </div>
            </td>
            <td><a href="/sources/{{ doc.source_id }}">{{ doc.source_id }}</a></td>
            <td>{{ doc.mime_type }}</td>
            <td>{{ doc.size_str }}</td>
            <td>{{ doc.date_str }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% if has_pagination %}
<div class="pagination">
    {% if has_prev_cursor %}
    <a href="javascript:void(0)" onclick="goToPage('{{ prev_cursor_val }}')" class="page-link">&laquo; Previous</a>
    {% endif %}
    {% if start_position > 0 %}
    <span class="page-position">{{ start_position }}-{{ end_position }} of {{ total_count }}</span>
    {% endif %}
    {% if has_next_cursor %}
    <a href="javascript:void(0)" onclick="goToPage('{{ next_cursor_val }}')" class="page-link">Next &raquo;</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<div id="browse-config" hidden
     data-active-tags="{{ active_tags_json }}"
     data-prev-cursor="{{ prev_cursor_val }}"
     data-has-prev-cursor="{{ has_prev_cursor }}"
     data-next-cursor="{{ next_cursor_val }}"
     data-has-next-cursor="{{ has_next_cursor }}"
     data-per-page="{{ per_page }}"></div>
<script>
(function() {
    var cfg = document.getElementById('browse-config').dataset;
    var typeToggles = document.querySelectorAll('.type-toggle input');
    var tagInput = document.getElementById('tag-search');
    var sourceSelect = document.getElementById('source-select');
    var activeTags = JSON.parse(cfg.activeTags || '[]');
    var perPage = parseInt(cfg.perPage, 10) || 50;

    function buildParams(cursor) {
        var params = new URLSearchParams();

        var types = [];
        typeToggles.forEach(function(t) {
            if (t.checked) types.push(t.value);
        });
        if (types.length > 0 && types.length < typeToggles.length) {
            params.set('types', types.join(','));
        }

        if (activeTags.length > 0) {
            params.set('tags', activeTags.join(','));
        }

        var source = sourceSelect.value;
        if (source) params.set('source', source);

        if (cursor) params.set('page', cursor);
        if (perPage !== 50) params.set('per_page', perPage);

        return params;
    }

    function updateFilters() {
        var params = buildParams(null);
        var qs = params.toString();
        window.location.href = '/' + (qs ? '?' + qs : '');
    }

    window.goToPage = function(cursor) {
        var params = buildParams(cursor);
        var qs = params.toString();
        window.location.href = '/' + (qs ? '?' + qs : '');
    };

    typeToggles.forEach(function(t) {
        t.addEventListener('change', updateFilters);
    });

    sourceSelect.addEventListener('change', updateFilters);

    tagInput.addEventListener('change', function() {
        var tag = tagInput.value.trim();
        if (tag && !activeTags.includes(tag)) {
            activeTags.push(tag);
            tagInput.value = '';
            updateFilters();
        }
    });

    tagInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            var tag = tagInput.value.trim();
            if (tag && !activeTags.includes(tag)) {
                activeTags.push(tag);
                tagInput.value = '';
                updateFilters();
            }
        }
    });

    window.removeTag = function(index) {
        activeTags.splice(index, 1);
        updateFilters();
    };
})();
</script>
{% endblock %}
